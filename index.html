<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Chat Demo with QRCode</title>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial; padding:20px; }
    #chat { border:1px solid #ccc; height:200px; overflow:auto; margin-top:10px; }
    #msg { width:80%; }
    #status { margin:10px 0; font-weight:bold; color:blue; }
    #qrcode { margin-top:10px; }
  </style>
</head>
<body>
  <h2>WebRTC Chat Demo</h2>

  <button onclick="createRoom()">é–‹æˆ¿</button>
  <br><br>
  <label>æˆ¿è™Ÿï¼š</label><input id="roomId" type="text" readonly>
  <div id="status">å°šæœªå»ºç«‹æˆ¿é–“</div>

  <div id="qrcode"></div>

  <h3>èŠå¤©å®¤</h3>
  <div id="chat"></div>
  <input id="msg" type="text"><button onclick="sendMsg()">é€å‡º</button>

<script>
  // === Firebase è¨­å®š ===
const firebaseConfig = {
  apiKey: "AIzaSyAg9yuhB3c5s4JqQ_sW7iTVAr3faI3pdd8",
  authDomain: "web-rtc-1f615.firebaseapp.com",
  databaseURL: "https://web-rtc-1f615-default-rtdb.asia-southeast1.firebasedatabase.app", // ğŸ”¥ æ”¹é€™è£¡
  projectId: "web-rtc-1f615",
  storageBucket: "web-rtc-1f615.appspot.com",
  messagingSenderId: "369978320587",
  appId: "1:369978320587:web:8f1bf80a69c19e21051f4e"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  console.log("âœ… Firebase initialized", firebaseConfig);

  // === WebRTC ===
  let pc, channel, roomRef;
  const servers = { iceServers: [{urls: "stun:stun.l.google.com:19302"}] };

  function setStatus(text) {
    document.getElementById("status").innerText = text;
    console.log("ğŸ“¢ ç‹€æ…‹æ›´æ–°:", text);
  }

  function randomId(len = 6) {
    return Math.random().toString(36).substr(2, len);
  }

  async function createRoom() {
    const roomId = randomId();
    document.getElementById('roomId').value = roomId;
    roomRef = db.ref("rooms/"+roomId);
    console.log("ğŸ†• å»ºç«‹æˆ¿è™Ÿ:", roomId);

    // å»ºç«‹ QR Code
    document.getElementById("qrcode").innerHTML = "";
    const url = window.location.origin + window.location.pathname + "?room=" + roomId;
    new QRCode(document.getElementById("qrcode"), {
      text: url,
      width: 128,
      height: 128
    });
    console.log("ğŸ“± QR Code å·²ç”Ÿæˆ:", url);

    pc = new RTCPeerConnection(servers);

    // DataChannel
    channel = pc.createDataChannel("chat");
    channel.onopen = () => setStatus("âœ… DataChannel å·²é–‹å•Ÿï¼Œå¯ä»¥èŠå¤©");
    channel.onclose = () => setStatus("âŒ DataChannel å·²é—œé–‰");
    channel.onmessage = e => {
      console.log("ğŸ“© æ”¶åˆ°è¨Šæ¯:", e.data);
      addMsg("å°æ–¹: " + e.data);
    };

    pc.onicecandidate = e => {
      if (e.candidate) {
        console.log("ğŸ§Š Caller ICE candidate:", e.candidate);
        roomRef.child("callerCandidates").push(JSON.stringify(e.candidate));
      }
    };

    pc.onconnectionstatechange = () => {
      console.log("ğŸ”— Connection state:", pc.connectionState);
      setStatus("é€£ç·šç‹€æ…‹ï¼š" + pc.connectionState);
    };

    console.log("ğŸ“¡ å»ºç«‹ Offer ä¸­...");
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    console.log("âœ… Offer å»ºç«‹å®Œæˆ:", offer);

    console.log("ğŸ“¤ å¯«å…¥ Firebase...");
    await roomRef.set({ offer: JSON.stringify(offer) });
    setStatus("æˆ¿é–“å»ºç«‹å®Œæˆï¼Œè«‹åˆ†äº« QR Code çµ¦æœ‹å‹");

    roomRef.child("answer").on("value", async snap => {
      if (snap.val() && !pc.currentRemoteDescription) {
        console.log("ğŸ“¥ æ”¶åˆ° Answer:", snap.val());
        const answer = JSON.parse(snap.val());
        await pc.setRemoteDescription(answer);
        setStatus("å°æ–¹å·²åŠ å…¥æˆ¿é–“ï¼Œæ­£åœ¨é€£ç·š...");
      }
    });

    roomRef.child("calleeCandidates").on("child_added", snap => {
      console.log("ğŸ“¥ æ”¶åˆ° Callee ICE:", snap.val());
      pc.addIceCandidate(JSON.parse(snap.val()));
    });
  }

  async function joinRoom(roomId) {
    if (!roomId) return alert("æˆ¿è™Ÿä¸å­˜åœ¨");
    roomRef = db.ref("rooms/"+roomId);
    console.log("ğŸ”‘ åŠ å…¥æˆ¿è™Ÿ:", roomId);

    pc = new RTCPeerConnection(servers);

    pc.ondatachannel = e => {
      channel = e.channel;
      channel.onopen = () => setStatus("âœ… DataChannel å·²é–‹å•Ÿï¼Œå¯ä»¥èŠå¤©");
      channel.onclose = () => setStatus("âŒ DataChannel å·²é—œé–‰");
      channel.onmessage = ev => {
        console.log("ğŸ“© æ”¶åˆ°è¨Šæ¯:", ev.data);
        addMsg("å°æ–¹: " + ev.data);
      };
    };

    pc.onicecandidate = e => {
      if (e.candidate) {
        console.log("ğŸ§Š Callee ICE candidate:", e.candidate);
        roomRef.child("calleeCandidates").push(JSON.stringify(e.candidate));
      }
    };

    console.log("ğŸ“¥ è®€å–æˆ¿é–“è³‡æ–™...");
    const roomData = (await roomRef.get()).val();
    if (!roomData || !roomData.offer) {
      return setStatus("âŒ æˆ¿é–“ä¸å­˜åœ¨");
    }
    const offer = JSON.parse(roomData.offer);
    await pc.setRemoteDescription(offer);

    console.log("ğŸ“¡ å»ºç«‹ Answer ä¸­...");
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    console.log("âœ… Answer å»ºç«‹å®Œæˆ:", answer);

    console.log("ğŸ“¤ å›å‚³ Answer åˆ° Firebase...");
    await roomRef.child("answer").set(JSON.stringify(answer));

    setStatus("å·²åŠ å…¥æˆ¿é–“ï¼Œç­‰å¾…é€£ç·š...");

    roomRef.child("callerCandidates").on("child_added", snap => {
      console.log("ğŸ“¥ æ”¶åˆ° Caller ICE:", snap.val());
      pc.addIceCandidate(JSON.parse(snap.val()));
    });
  }

  function sendMsg() {
    if (!channel || channel.readyState !== "open") {
      alert("é€£ç·šå°šæœªå»ºç«‹");
      return;
    }
    const text = document.getElementById("msg").value;
    console.log("ğŸ“¤ ç™¼é€è¨Šæ¯:", text);
    channel.send(text);
    addMsg("æˆ‘: " + text);
    document.getElementById("msg").value = "";
  }

  function addMsg(text) {
    const div = document.getElementById("chat");
    div.innerHTML += "<div>"+text+"</div>";
    div.scrollTop = div.scrollHeight;
  }

  // === å•Ÿå‹•æ™‚æª¢æŸ¥ç¶²å€åƒæ•¸ ===
  window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get("room");
    if (roomId) {
      document.getElementById("roomId").value = roomId;
      console.log("ğŸšª é€²å…¥ç¶²å€å¸¶æˆ¿è™Ÿï¼Œè‡ªå‹•åŠ å…¥:", roomId);
      joinRoom(roomId); // è‡ªå‹•åŠ å…¥
    }
  };
</script>
</body>
</html>

